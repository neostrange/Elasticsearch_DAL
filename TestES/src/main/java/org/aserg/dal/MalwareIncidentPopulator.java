/**
 * 
 */
package org.aserg.dal;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;

import org.apache.commons.codec.digest.DigestUtils;
import org.aserg.model.MalwareIncident;
import org.aserg.model.Origin;
import org.aserg.model.VirusTotalScan;
import org.aserg.utility.EnrichmentUtility;
import org.aserg.utility.IOFileUtility;
import org.aserg.utility.SqlUtility;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * @author Waseem
 *
 */
public class MalwareIncidentPopulator {

	private static Logger log = LoggerFactory.getLogger(MalwareIncidentPopulator.class);

	/**
	 * 
	 * @see org.aserg.dal.IncidentPopulator#populate(java.sql.ResultSet)
	 */

	public List<MalwareIncident> populate() {
		log.info("Initiating MalwareIncident Population");
		int size = 0; // These are the number of records
		MalwareIncident malIncident = null; // To populate the Malware Objects
		HashMap<String, String> vtr = null; // HashMap will store the Scanner
		// and Result of a specific hash
		VirusTotalScan vts = null; // To populate the Virustotal Object in the
		List<MalwareIncident> malwareIncidentList = new ArrayList<MalwareIncident>();

		// Malware incident
		int count = 1;
		String prev = null;
		String lastFetchTime = IOFileUtility.readProperty("malwareTime", IOFileUtility.STATE_PATH);
		log.debug("Run query to get malware count");
		ResultSet rslast = SqlUtility.getResultSet(SqlUtility.MALWARE_INCIDENT_QUERY_COUNT,
				SqlUtility.getDionaeaConnection(), lastFetchTime);
		ResultSet rs = null;

		try {
			size = rslast.getInt("total");
			log.debug("Number of new malware incidents [{}], since last fetched at [{}] ", size, lastFetchTime);
			if (size > 0) {
				log.debug("Run query to fetch malware records");
				rs = SqlUtility.getResultSet(SqlUtility.MALWARE_INCIDENT_QUERY, SqlUtility.getDionaeaConnection(),
						IOFileUtility.readProperty("malwareTime", IOFileUtility.STATE_PATH));
				IOFileUtility.writeProperty("malwareTime", rslast.getString("connection_datetime"),
						IOFileUtility.STATE_PATH);

				try {
					while (rs.next()) {
						Origin org = EnrichmentUtility.getOrigin(rs.getString("remote_host"));
						org = org == null ? null : org;
						// if equal to prev record
						if (rs.getString("order_id").equals(prev)) {
							log.debug("MalwareIncident same as previous, connection [{}] ", prev);
							vtr.put(rs.getString("virustotalscan_scanner"), rs.getString("virustotalscan_result"));

						} else {
							// add prev malIncident to list, or the last one
							if (malIncident != null) {
								if (vts != null) {
									vts.setVTscanResults(vtr);
									malIncident.setVtScan(vts);
								}
								malwareIncidentList.add(malIncident);
								log.debug("Added MalwareIncident to list, connection [{}], vtScan [{}]", prev,
										malIncident.getVtScan());
								vts = null;
							}

							vtr = new HashMap<String, String>();
							String datetime;
							try {
								datetime = rs.getString("connection_datetime");
								malIncident = new MalwareIncident(datetime.replace(' ', 'T'),
										rs.getString("remote_host"), rs.getInt("remote_port"),
										rs.getString("connection_protocol"), rs.getString("local_host"),
										rs.getInt("local_port"), rs.getString("connection_transport"), org,
										rs.getString("download_md5_hash"), rs.getString("download_url"),
										rs.getString("download_url"), null, vts);
								if (rs.getString("virustotal_permalink") != null) {
									vtr.put(rs.getString("virustotalscan_scanner"),
											rs.getString("virustotalscan_result"));
									vts = new VirusTotalScan(rs.getString("virustotal_permalink"), vtr);
									malIncident.setVtScan(vts);
								}

								prev = rs.getString("order_id");
							} catch (SQLException e) {
								log.error("Error occurred while trying to traverse through MalwareIncident ResultSet",
										e);
							}

						}

						// for the last one
						if (count == size && !malwareIncidentList.contains(malIncident)) {
							System.out.println(count);
							malwareIncidentList.add(malIncident);
						}
						count++;
					}
				} catch (SQLException e) {
					log.error("Error occurred while trying to traverse through ResultSet", e);
				}

			}
		} catch (SQLException e) {
			log.error("Error occurred while trying to get ResultSet", e);
		}

		SqlUtility.closeConnection(SqlUtility.getDionaeaConnection());
		log.info("MalwareIncident Population Successful");
		return malwareIncidentList;
	}

	public List<MalwareIncident> populateSsh() {
		log.info("Initiating SSH MalwareIncident Population");
		List<MalwareIncident> malwareIncidentList = new ArrayList<MalwareIncident>();
		MalwareIncident malwareIncident = null;
		String lastFetchTime = IOFileUtility.readProperty("sshMalwareTime", IOFileUtility.STATE_PATH);
		log.debug("Run query to fetch SSH malware records");
		ResultSet rs = SqlUtility.getResultSet(SqlUtility.SSH_MALWARE_INCIDENT_QUERY, SqlUtility.getKippoConnection(),
				lastFetchTime);

		try {

			while (rs.next()) {

				String remotehost = rs.getString("remotehost");

				Origin origin = EnrichmentUtility.getOrigin(remotehost);
				origin = origin == null ? null : origin;

				// Calculate malware hash
				FileInputStream fis = null;
				String hash = "";
				try {
					fis = new FileInputStream(
							new File(IOFileUtility.readProperty("MALWARE_BIN_PATH", IOFileUtility.STATE_PATH)
									+ rs.getString("payload")));
					hash = DigestUtils.md5Hex(fis);
					fis.close();
					log.debug("Calculated MD5 digest [{}], for binary file [{}]", hash, rs.getString("payload"));
				} catch (FileNotFoundException fne) {
					log.error("Error occurred while trying to read malware binary [{}] for calculating hash",
							rs.getString("payload"), fne);
				}
				// In case a malware has been downloaded
				IOFileUtility.writeProperty("sshMalwareTime", rs.getString("connection_datetime"),
						IOFileUtility.STATE_PATH);
				malwareIncident = new MalwareIncident(rs.getString("connection_datetime").replace(' ', 'T'), remotehost,
						22, "ssh", IOFileUtility.readProperty("HOST", IOFileUtility.ARCHIVAL_PATH), 22, null, origin,
						hash, rs.getString("url"), rs.getString("payload"), rs.getString("id"), null);
				malwareIncidentList.add(malwareIncident);
				log.debug("Added SSH MalwareIncident, id [{}] to list ", rs.getString("id"));

			}
		} catch (SQLException | IOException e) {
			log.error("Error occurred while trying to traverse through SSH MalwareIncident ResultSet", e);
		}
		SqlUtility.closeConnection(SqlUtility.getKippoConnection());
		log.debug("Number of new SSH MalwareIncidents [{}], since last fetched at time [{}] ",
				malwareIncidentList.size(), lastFetchTime);
		log.info("SSH MalwareIncident Population Successful");
		return malwareIncidentList;
	}

}
